<!DOCTYPE html>
<html>

<head>
    <title>French Word Slideshow Generator</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        #container {
            width: 80%;
            max-width: 800px;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Input Area Styles */
        #input-area {
            margin-bottom: 20px;
        }

        #word-list {
            height: 200px;
            /* Fixed height for the textarea */
        }

        #load-list-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* Slideshow Container Styles */
        #slideshow-container {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
            /* Remove fixed height */
            display: none;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            /* Use flexbox to position image and text */
            flex-direction: row;
            /* Arrange items in a row */
            justify-content: space-between;
            /* Distribute space evenly */
            align-items: center;
            /* Align items vertically */
            padding: 20px;
            /* Add some padding */
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .slide.active {
            opacity: 1;
        }

        /* Gender-based color schemes */
        .slide.masculine {
            background: linear-gradient(to bottom, #64b5f6, #2196f3);
            /* Blueish */
        }

        .slide.feminine {
            background: linear-gradient(to bottom, #f48fb1, #e91e63);
            /* Pinkish */
        }

        .slide.neutral {
            background: linear-gradient(to bottom, #a1887f, #795548);
            /* Brownish */
        }

        /* Navigation Buttons Styles */
        #navigation-buttons {
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        #edit-button {
            margin-top: 10px;
        }

        /* English Word Styles */
        .english-word {
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            /* Indicate it's clickable */
            user-select: none;
            /* Prevent text selection during double click */
        }

        .english-word.hidden {
            color: transparent;
            /* Hide the text */
        }

        .english-word.hidden::before {
            content: "??????";
            /* Placeholder - adjust length as needed */
            color: rgba(255, 255, 255, 0.5);
            /* Faded question marks */
        }

        /* Guessable Rules Styles */
        #guessable-rules {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-align: center;
            display: none;
            /* Initially hidden */
        }

        #guessable-rules a {
            color: #007bff;
            text-decoration: none;
        }

        #guessable-rules a:hover {
            text-decoration: underline;
        }

        /* Slide Buttons Styles */
        .slide-buttons {
            margin-top: 15px;
            display: none;
            /* Hide buttons by default */
        }

        .slide.active .slide-buttons {
            display: block !important;
            /* Override any other display rules */
        }

        .slide-buttons a {
            display: inline-block;
            padding: 6px 10px;
            /* Reduced padding */
            margin: 0 3px;
            /* Reduced margin */
            background-color: #ddd;
            /* Light gray background */
            color: #333;
            /* Dark gray text */
            text-decoration: none;
            border-radius: 4px;
            /* Slightly smaller border radius */
            font-size: 0.9em;
            /* Smaller font size */
            border: none;
            /* Removed border */
        }

        .slide-buttons a:hover {
            background-color: #ccc;
            /* Slightly darker gray on hover */
        }

        /* Image Styles */
        .pixabay-image {
            max-width: 80%;
            max-height: 300px;
            object-fit: contain;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .image-placeholder {
            width: 300px;
            height: 300px;
            background-color: #eee;
            border: 1px dashed #999;
            color: #777;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 5px;
            font-size: 5em;
            /* Make the question mark bigger */
            margin-left: 20px;
        }

        /* Text container to take up remaining space */
        .text-container {
            flex-grow: 1;
            /* Allows the text container to fill the remaining space */
            text-align: center;
            /* Center the text within the container */
        }

        /* Delete Image Button Styles */
        .delete-image-button {
            background-color: #f44336;
            /* Red */
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .delete-image-button:hover {
            background-color: #d32f2f;
        }

        /* Error Message Styles */
        #error-message {
            color: red;
            margin-top: 10px;
            text-align: center;
        }

        /* Clear List Button Styles */
        #clear-list-button {
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <div id="container">
        <h1>French Word Slideshow Generator</h1>

        <div id="input-area">
            <div id="load-list-area">
                <label for="list-selector">Load Predefined List:</label>
                <select id="list-selector" class="form-control" style="width: auto;">
                    <!-- Options will be dynamically added here -->
                </select>
                <button id="load-list-button" class="btn btn-secondary">Load List</button>
            </div>

            <label for="word-list">Enter English word, gender prefix, and French noun (one per line):</label>
            <textarea id="word-list" class="form-control" rows="5" placeholder="Example:
dog le chien
table la table
man un homme
woman une femme"></textarea>

            <button id="clear-list-button" class="btn btn-warning btn-block">Clear List</button>
        </div>

        <button id="generate-button" class="btn btn-primary btn-block">Generate Slideshow</button>

        <div id="slideshow-container">
            <!-- Slides will be dynamically added here -->
        </div>

        <div id="navigation-buttons">
            <button id="prev-button" class="btn btn-secondary">Previous</button>
            <button id="next-button" class="btn btn-secondary">Next</button>
            <button id="shuffle-button" class="btn btn-secondary">Shuffle</button>
            <button id="edit-button" class="btn btn-secondary">Edit List</button>
        </div>

        <div id="guessable-rules">
            <p><b>Quick Gender Guessing Rule:</b></p>
            <p>Most words ending in 'e' or 'ion' are feminine, except those ending in '-age', '-ege', '-Ã©', or '-isme',
                which are usually masculine. Most other endings are masculine.</p>
            <p>For a more detailed explanation, see <a href="https://frenchtogether.com/french-nouns-gender/"
                    target="_blank">French Noun Gender Rules</a>.</p>
            <p>For even more information, you can also read <a
                    href="https://mangolanguages.com/resources/learn/grammar/french/how-to-determine-the-gender-of-nouns-in-french"
                    target="_blank">this page</a>.</p>
        </div>

        <div id="error-message">
            <!-- Error messages will be displayed here -->
        </div>
    </div>

    <script>
        $(document).ready(function () {

            // ------------------------------------------------------------------------
            // Configuration
            // ------------------------------------------------------------------------

            const config = {
                localStorageKey: "frenchWordList",
                pixabayApiKey: "48411023-77af553a827e1673d414ebb53", // TODO: Consider a more secure way to store this
                blacklistKey: "pixabayBlacklist",
                availableLists: ["list1.txt"], // Hardcoded list of available files
                maxImageLoadFailures: 5,
            };

            // ------------------------------------------------------------------------
            // DOM Elements
            // ------------------------------------------------------------------------

            const dom = {
                inputArea: $("#input-area"),
                wordListTextarea: $("#word-list"),
                generateButton: $("#generate-button"),
                slideshowContainer: $("#slideshow-container"),
                navigationButtons: $("#navigation-buttons"),
                prevButton: $("#prev-button"),
                nextButton: $("#next-button"),
                shuffleButton: $("#shuffle-button"),
                editButton: $("#edit-button"),
                errorMessage: $("#error-message"),
                listSelector: $("#list-selector"),
                loadListButton: $("#load-list-button"),
                guessableRulesDiv: $("#guessable-rules"),
                clearListButton: $("#clear-list-button")
            };

            // ------------------------------------------------------------------------
            // Variables
            // ------------------------------------------------------------------------

            let slides = [];
            let currentSlideIndex = 0;
            let imageLoadFailures = 0;
            let imageLoadingEnabled = true;

            // ------------------------------------------------------------------------
            // Helper Functions - Local Storage
            // ------------------------------------------------------------------------

            // Function to get item from local storage with error handling
            function getLocalStorageItem(key) {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.error("Error accessing localStorage:", e);
                    displayErrorMessage("Error accessing local storage. See console for details.");
                    return null;
                }
            }

            // Function to set item in local storage with error handling
            function setLocalStorageItem(key, value) {
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    console.error("Error setting localStorage:", e);
                    displayErrorMessage("Error saving to local storage. See console for details.");
                }
            }

            // Function to remove item from local storage with error handling
            function removeLocalStorageItem(key) {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.error("Error removing from localStorage:", e);
                    displayErrorMessage("Error removing from local storage. See console for details.");
                }
            }

            // ------------------------------------------------------------------------
            // Helper Functions - Image Blacklist
            // ------------------------------------------------------------------------

            // Function to get the image blacklist from local storage
            function getImageBlacklist() {
                const blacklistString = getLocalStorageItem(config.blacklistKey);
                return blacklistString ? JSON.parse(blacklistString) : [];
            }

            // Function to save the image blacklist to local storage
            function saveImageBlacklist(blacklist) {
                setLocalStorageItem(config.blacklistKey, JSON.stringify(blacklist));
            }

            // ------------------------------------------------------------------------
            // Helper Functions - Error Handling
            // ------------------------------------------------------------------------

            function displayErrorMessage(message) {
                dom.errorMessage.text(message);
            }

            // ------------------------------------------------------------------------
            // Helper Functions - Gender Guessing
            // ------------------------------------------------------------------------

            // Function to determine if the gender is "guessable" based on the noun's ending
            function isGuessable(frenchWord, prefix) {
                const lowerCaseWord = frenchWord.toLowerCase();
                let expectedGender = null;

                if (lowerCaseWord.endsWith('e') || lowerCaseWord.endsWith('ion')) {
                    // Likely feminine, unless it's an exception
                    if (lowerCaseWord.endsWith('age') || lowerCaseWord.endsWith('ege') || lowerCaseWord.endsWith('Ã©') ||
                        lowerCaseWord.endsWith('isme')) {
                        expectedGender = 'masculine'; // Exception: Likely masculine
                    } else {
                        expectedGender = 'feminine'; // Likely feminine
                    }
                } else {
                    expectedGender = 'masculine'; // Likely masculine
                }

                // Determine actual gender from prefix
                let actualGender = null;
                if (["le", "un"].includes(prefix)) {
                    actualGender = 'masculine';
                } else if (["la", "une"].includes(prefix)) {
                    actualGender = 'feminine';
                } else {
                    console.warn("Unexpected prefix:", prefix); // Should not happen due to validation
                    return false; // Treat as not guessable
                }

                return expectedGender === actualGender; // Return true if guess matches actual
            }

            // ------------------------------------------------------------------------
            // Helper Functions - Data Loading and Validation
            // ------------------------------------------------------------------------

            // Function to load list from file and validate
            function loadListFromFile(filename) {
                fetch(filename)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to load file: ${filename} (status ${response.status})`);
                        }
                        return response.text();
                    })
                    .then(text => {
                        if (!text) {
                            displayErrorMessage(`File ${filename} is empty.`);
                            console.warn(`File ${filename} is empty.`);
                            return;
                        }

                        let validLines = [];
                        const lines = text.split('\n');

                        lines.forEach(line => {
                            line = line.trim();
                            if (!line) return; // Skip empty lines

                            const parts = line.split(' ');
                            if (parts.length < 3) {
                                console.warn("Invalid line format: ", line);
                                displayErrorMessage(
                                    "Invalid line format in file. Please use 'english prefix french'. See console for more."
                                );
                                return;
                            }

                            const englishWord = parts[0].trim();
                            const prefix = parts[1].trim().toLowerCase();
                            const frenchWord = parts.slice(2).join(' ').trim(); // Handle multi-word French nouns

                            const validPrefixes = ["le", "la", "un", "une"];
                            if (!validPrefixes.includes(prefix)) {
                                console.warn("Invalid prefix: ", prefix, " in line: ", line);
                                displayErrorMessage(
                                    "Invalid gender prefix in file. Valid prefixes are: le, la, un, une. See console for more."
                                );
                                return;
                            }
                            validLines.push(line);
                        });

                        dom.wordListTextarea.val(validLines.join('\n')); // Replace existing content
                        setLocalStorageItem(config.localStorageKey, dom.wordListTextarea.val()); // Update local storage

                    })
                    .catch(error => {
                        displayErrorMessage(`Error loading list from ${filename}. See console for details.`);
                        console.error("Error loading list:", error);
                    });
            }

            // ------------------------------------------------------------------------
            // Helper Functions - Array Manipulation
            // ------------------------------------------------------------------------

            // Fisher-Yates shuffle algorithm
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]]; // Swap elements
                }
            }

            // ------------------------------------------------------------------------
            // Helper Functions - Slide Generation
            // ------------------------------------------------------------------------

            // Function to generate the HTML content for a slide
            function generateSlideContent(englishWord, wordWithOne, wordWithDefiniteArticle, possessiveArticle,
                frenchWord, guessableText) {
                // 2. Linguee Link
                const lingueeURL =
                    `https://www.linguee.com/french-english/search?source=auto&query=${encodeURIComponent(frenchWord)}`;

                // 3. Interactive English Word Reveal
                const englishWordDisplay = `<span class="english-word hidden" data-revealed="false">${englishWord}</span>`;

                // Construct the URLs
                const googleTranslateURL =
                    `https://translate.google.co.uk/?sl=fr&tl=en&text=${encodeURIComponent(frenchWord)}&op=translate}`;
                const wordReferenceURL = `https://www.wordreference.com/fren/${encodeURIComponent(frenchWord)}`;
                const forvoURL = `https://forvo.com/word/${encodeURIComponent(frenchWord)}/#fr`;

                // Gender Guessing Link
                const genderGuessingURL = "https://mangolanguages.com/resources/learn/grammar/french/how-to-determine-the-gender-of-nouns-in-french";

                return `
                    <div class="text-container">
                        <p><b style="font-size:1.2em">${englishWordDisplay}</b></p>
                        <p>${wordWithOne}</p>
                        <p>${wordWithDefiniteArticle}</p>
                        <p>${possessiveArticle} ${frenchWord}</p>
                        <p>${guessableText} - <a href="${genderGuessingURL}" target="_blank">Learn more</a></p>
                        <div class="slide-buttons">
                            <a href="${googleTranslateURL}" target="_blank">Google Translate</a>
                            <a href="${wordReferenceURL}" target="_blank">WordReference</a>
                            <a href="${forvoURL}" target="_blank">Pronunciation (Forvo)</a>
                            <a href="${lingueeURL}" target="_blank">Linguee</a>
                            <button class="delete-image-button" data-frenchword="${frenchWord}">Delete Image</button>
                        </div>
                    </div>
                    <div class="image-placeholder">?</div>
                `;
            }

            async function loadImageForSlide(slide) {
                if (!imageLoadingEnabled) {
                    console.warn("Image loading is disabled.  Skipping image load for slide.");
                    return;
                }

                const englishWord = slide.data("english-word");
                const frenchWord = slide.find(".delete-image-button").data("frenchword"); // Extract frenchWord

                if (!englishWord) {
                    console.warn("No English word found for slide.  Cannot load image.");
                    return;
                }

                // Abort any existing request
                let abortController = slide.data('abortController');
                if (abortController) {
                    console.log("Aborting previous image request for", englishWord);
                    abortController.abort();
                }

                abortController = new AbortController();
                slide.data('abortController', abortController); // Store abortController in slide data
                const signal = abortController.signal;

                // Display "Loading image..." placeholder
                updateSlideWithPlaceholder(slide, "Loading image...");

                let imageURL = getLocalStorageItem(frenchWord);
                const imageBlacklist = getImageBlacklist();

                // Check if image is blacklisted
                if (imageURL && imageBlacklist.includes(imageURL)) {
                    console.warn("Image for", frenchWord, "is blacklisted:", imageURL);
                    removeLocalStorageItem(frenchWord); // Remove blacklisted image from cache
                    imageURL = null; // Force API call
                }

                if (imageURL) {
                    // Image found in local storage
                    console.log("Image found in local storage for", frenchWord, ":", imageURL);
                    updateSlideWithImage(slide, imageURL);
                    return;
                }

                try {
                    console.log("Fetching image from Pixabay for", englishWord);
                    const response = await $.ajax({
                        url: `https://pixabay.com/api/?key=${config.pixabayApiKey}&q=${encodeURIComponent(englishWord)}&image_type=photo`,
                        dataType: 'jsonp',
                        signal: signal // Pass the AbortSignal to the request
                    });

                    if (signal.aborted) {
                        console.log("Image request aborted for", englishWord);
                        return;
                    }

                    if (response.hits.length > 0) {
                        let validImageFound = false;
                        const imageBlacklist = getImageBlacklist();

                        for (let i = 0; i < response.hits.length; i++) {
                            const hit = response.hits[i];
                            if (!imageBlacklist.includes(hit.webformatURL)) {
                                imageURL = hit.webformatURL;
                                validImageFound = true;
                                break;
                            }
                        }

                        if (validImageFound) {
                            console.log("Image found from Pixabay for", englishWord, ":", imageURL);
                            setLocalStorageItem(frenchWord, imageURL); // Save to local storage
                            updateSlideWithImage(slide, imageURL);
                        } else {
                            console.warn("No non-blacklisted images found on Pixabay for", englishWord);
                            updateSlideWithPlaceholder(slide, "No suitable image found");
                        }
                    } else {
                        console.warn("No images found on Pixabay for", englishWord);
                        updateSlideWithPlaceholder(slide, "No image found");
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log("Image fetch aborted for", englishWord);
                    } else {
                        console.error("Error fetching image for", englishWord, ":", error);
                        imageLoadFailures++;
                        console.log("Image load failures:", imageLoadFailures);

                        if (imageLoadFailures > config.maxImageLoadFailures) {
                            console.warn("Too many image load failures. Disabling image loading.");
                            imageLoadingEnabled = false;
                            displayErrorMessage("Image loading has been disabled due to excessive errors.");
                        }
                        updateSlideWithPlaceholder(slide, "Error loading image");
                    }
                }
            }

            function updateSlideWithImage(slide, imageURL) {
                const imageDisplay = `<img src="${imageURL}" alt="${slide.data('english-word')}" class="pixabay-image">`;
                slide.find('.image-placeholder').html(imageDisplay); // Add image inside the placeholder
            }

            function updateSlideWithPlaceholder(slide, message) {
                let content = "?";
                if (message) {
                    content = message;
                }
                slide.find('.image-placeholder').html(content); // Set the placeholder text
            }

            // Function to generate a single slide
            async function generateSlide(line) {
                line = line.trim();
                if (!line) return null; // Skip empty lines

                const parts = line.split(' ');
                if (parts.length < 3) {
                    console.warn("Invalid line format: ", line);
                    displayErrorMessage(
                        "Invalid line format. Please use 'english prefix french'. See console for more.");
                    return null;
                }

                const englishWord = parts[0].trim();
                const prefix = parts[1].trim().toLowerCase();
                const frenchWord = parts.slice(2).join(' ').trim(); // Handle multi-word French nouns

                const validPrefixes = ["le", "la", "un", "une"];
                if (!validPrefixes.includes(prefix)) {
                    console.warn("Invalid prefix: ", prefix, " in line: ", line);
                    displayErrorMessage("Invalid gender prefix. Valid prefixes are: le, la, un, une. See console for more.");
                    return null;
                }

                let genderClass = 'neutral';
                if (["le", "un"].includes(prefix)) {
                    genderClass = 'masculine';
                } else if (["la", "une"].includes(prefix)) {
                    genderClass = 'feminine';
                }

                let definiteArticle = (prefix === "un" || prefix === "une") ? "" : prefix; // initailise as before

                const startsWithVowelOrH = /^[aeiouh]/i.test(frenchWord); // use regex

                if (startsWithVowelOrH && (prefix === "le" || prefix === "la")) {
                    definiteArticle = "l'"; // Contract the article
                } else {
                    definiteArticle = prefix;
                }

                const possessiveArticle = (genderClass === 'masculine') ? "son" : "ta";
                const wordWithDefiniteArticle = definiteArticle + " " + frenchWord;
                const wordWithOne = (genderClass === 'masculine') ? "un " + frenchWord : "une " + frenchWord;

                const guessable = isGuessable(frenchWord, prefix);
                let guessableText = guessable ? "â Guessable" : "â Not Guessable";

                // Image Handling - Store English word for later loading
                const slideContent = generateSlideContent(englishWord, wordWithOne, wordWithDefiniteArticle,
                    possessiveArticle, frenchWord, guessableText); // No image URL initially

                const slide = $(`<div class="slide ${genderClass}" data-english-word="${englishWord}" data-ever-revealed="false">${slideContent}</div>`);

                // Initialize AbortController early
                slide.data('abortController', new AbortController());

                return slide;
            }

            // ------------------------------------------------------------------------
            // Main Function - Generate Slideshow
            // ------------------------------------------------------------------------

            async function generateSlideshow(wordList) {
                dom.slideshowContainer.empty(); // Clear any existing slides
                slides = []; // Reset the slides array
                currentSlideIndex = 0;
                displayErrorMessage(""); // Clear any previous errors
                imageLoadFailures = 0; // Reset image load failures
                imageLoadingEnabled = true; // Re-enable image loading

                let lines = wordList.split('\n');
                shuffleArray(lines); // Shuffle the array of lines

                let validWordsCount = 0;

                for (const line of lines) {
                    const slide = await generateSlide(line);
                    if (slide) {
                        dom.slideshowContainer.append(slide);
                        slides.push(slide);
                        validWordsCount++;
                    }
                }

                if (validWordsCount === 0) {
                    displayErrorMessage("No valid words found in the input.");
                    return;
                }

                // Save word list to local storage
                setLocalStorageItem(config.localStorageKey, wordList);

                showSlide(0); // Show the first slide - NOW IN THE CORRECT PLACE!
                dom.inputArea.hide();
                dom.generateButton.hide();
                dom.slideshowContainer.show();
                dom.navigationButtons.show();
                dom.guessableRulesDiv.show(); // Show the rules div
            }

            // ------------------------------------------------------------------------
            // Helper Function - Slide Display
            // ------------------------------------------------------------------------

            function showSlide(index) {
                if (index < 0) {
                    currentSlideIndex = slides.length - 1;
                } else if (index >= slides.length) {
                    currentSlideIndex = 0;
                } else {
                    currentSlideIndex = index;
                }

                $(".slide").removeClass("active");
                const currentSlide = slides[currentSlideIndex];
                currentSlide.addClass("active");

                // Load image when slide becomes active, but only if the english word has been revealed
                // or if it was ever revealed before
                const englishWordSpan = currentSlide.find(".english-word");
                const everRevealed = currentSlide.data("ever-revealed");

                if (!englishWordSpan.hasClass("hidden") || everRevealed) {
                    loadImageForSlide(currentSlide);
                }
            }

            // ------------------------------------------------------------------------
            // Event Handlers
            // ------------------------------------------------------------------------

            // Generate Slideshow Button Click
            dom.generateButton.click(function () {
                const wordList = dom.wordListTextarea.val();
                generateSlideshow(wordList);
            });

            // Previous Button Click
            dom.prevButton.click(function () {
                showSlide(currentSlideIndex - 1);
            });

            // Next Button Click
            dom.nextButton.click(function () {
                showSlide(currentSlideIndex + 1);
            });

            // Shuffle Button Click
            dom.shuffleButton.click(function () {
                const wordList = dom.wordListTextarea.val();
                generateSlideshow(wordList);
            });

            // Edit Button Click
            dom.editButton.click(function () {
                dom.slideshowContainer.hide();
                dom.navigationButtons.hide();
                dom.guessableRulesDiv.hide(); // Hide the rules div
                dom.inputArea.show();
                dom.generateButton.show();
            });

            // Clear List Button Click
            dom.clearListButton.click(function () {
                dom.wordListTextarea.val("");
                removeLocalStorageItem(config.localStorageKey);
            });

            // Save word list to local storage when the textarea changes
            dom.wordListTextarea.on('input', function () {
                setLocalStorageItem(config.localStorageKey, dom.wordListTextarea.val());
            });

            // Event delegation for dynamically added "Delete Image" buttons
            dom.slideshowContainer.on("click", ".delete-image-button", function () {
                const frenchWord = $(this).data("frenchword");
                const imageURL = getLocalStorageItem(frenchWord); // Get URL before deleting

                if (frenchWord) {
                    // Remove from local storage
                    removeLocalStorageItem(frenchWord);

                    // Add to blacklist
                    const blacklist = getImageBlacklist();
                    if (imageURL && !blacklist.includes(imageURL)) {
                        blacklist.push(imageURL);
                        saveImageBlacklist(blacklist);
                        console.log("Image blacklisted:", imageURL, "for word:", frenchWord);
                    }

                    // Re-generate the slideshow to update the current view
                    const wordList = dom.wordListTextarea.val();
                    generateSlideshow(wordList);
                } else {
                    console.warn("French word not found for delete image button.");
                }
            });

            // Interactive English Word Reveal - Single Click to Toggle
            dom.slideshowContainer.on("click", ".english-word", function () {
                const $this = $(this);
                const revealed = $this.data("revealed");
                const slide = $this.closest(".slide");

                if (revealed) {
                    // Hide the word
                    $this.addClass("hidden");
                    $this.data("revealed", false);
                } else {
                    // Show the word
                    $this.removeClass("hidden");
                    $this.data("revealed", true);

                    // Set the "ever-revealed" flag to true
                    slide.data("ever-revealed", true);

                    // Load the image if it's the active slide
                    if (slide.hasClass("active")) {
                        loadImageForSlide(slide);
                    }
                }
            });


            // ------------------------------------------------------------------------
            // Initialization
            // ------------------------------------------------------------------------

            // Populate the list selector
            config.availableLists.forEach(filename => {
                dom.listSelector.append($("<option>").val(filename).text(filename));
            });

            // Load list on button click
            dom.loadListButton.click(function () {
                const selectedFile = dom.listSelector.val();
                loadListFromFile(selectedFile);
            });

            // Load word list from local storage on page load
            if (getLocalStorageItem(config.localStorageKey)) {
                dom.wordListTextarea.val(getLocalStorageItem(config.localStorageKey));
            }

        });
    </script>

</body>

</html>
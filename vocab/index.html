<!DOCTYPE html>
<html>
<head>
    <title>French Word Slideshow Generator</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        #container {
            width: 80%;
            max-width: 800px;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #input-area {
            margin-bottom: 20px;
        }

        #word-list {
            height: 200px; /* Fixed height for the textarea */
        }

        #slideshow-container {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
            height: 300px; /* Fixed height for consistent layout */
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.7em; /* Adjusted font size */
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .slide.active {
            opacity: 1;
        }

        /* Gender-based color schemes */
        .slide.masculine {
            background: linear-gradient(to bottom, #64b5f6, #2196f3); /* Blueish */
        }

        .slide.feminine {
            background: linear-gradient(to bottom, #f48fb1, #e91e63); /* Pinkish */
        }

        .slide.neutral {
            background: linear-gradient(to bottom, #a1887f, #795548); /* Brownish */
        }

        #navigation-buttons {
            text-align: center;
            margin-top: 10px;
        }

        #error-message {
            color: red;
            margin-top: 10px;
            text-align: center;
        }

        #edit-button {
            margin-top: 10px;
        }

        .english-word {
            font-size: 1.5em;
            font-weight: bold;
        }

        #load-list-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        #guessable-rules {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-align: center;
            display: none; /* Initially hidden */
        }

        #guessable-rules a {
            color: #007bff;
            text-decoration: none;
        }

        #guessable-rules a:hover {
            text-decoration: underline;
        }

    </style>
</head>
<body>

<div id="container">
    <h1>French Word Slideshow Generator</h1>

    <div id="input-area">
        <div id="load-list-area">
            <label for="list-selector">Load Predefined List:</label>
            <select id="list-selector" class="form-control" style="width: auto;">
                <!-- Options will be dynamically added here -->
            </select>
            <button id="load-list-button" class="btn btn-secondary">Load List</button>
        </div>

        <label for="word-list">Enter English word, gender prefix, and French noun (one per line):</label>
        <textarea id="word-list" class="form-control" rows="5"
                  placeholder="Example:
dog le chien
table la table
man un homme
woman une femme"></textarea>
    </div>

    <button id="generate-button" class="btn btn-primary btn-block">Generate Slideshow</button>

    <div id="slideshow-container" style="display: none;">
        <!-- Slides will be dynamically added here -->
    </div>

    <div id="navigation-buttons" style="display: none;">
        <button id="prev-button" class="btn btn-secondary">Previous</button>
        <button id="next-button" class="btn btn-secondary">Next</button>
        <button id="shuffle-button" class="btn btn-secondary">Shuffle</button>
        <button id="edit-button" class="btn btn-secondary">Edit List</button>
    </div>

    <div id="guessable-rules">
        <p><b>Quick Gender Guessing Rule:</b></p>
        <p>Most words ending in 'e' are feminine, except those ending in '-age', '-ege', '-é', or '-isme', which are usually masculine.  Most other endings are masculine.</p>
        <p>For a more detailed explanation, see <a href="https://frenchtogether.com/french-nouns-gender/" target="_blank">French Noun Gender Rules</a>.</p>
    </div>

    <div id="error-message">
        <!-- Error messages will be displayed here -->
    </div>
</div>

<script>
    $(document).ready(function () {

        const inputArea = $("#input-area");
        const wordListTextarea = $("#word-list");
        const generateButton = $("#generate-button");
        const slideshowContainer = $("#slideshow-container");
        const navigationButtons = $("#navigation-buttons");
        const prevButton = $("#prev-button");
        const nextButton = $("#next-button");
        const shuffleButton = $("#shuffle-button");
        const editButton = $("#edit-button");
        const errorMessage = $("#error-message");
        let slides = [];
        let currentSlideIndex = 0;
        const localStorageKey = "frenchWordList";

        // New elements
        const listSelector = $("#list-selector");
        const loadListButton = $("#load-list-button");
        const availableLists = ["list1.txt"]; // Hardcoded list of available files
        const guessableRulesDiv = $("#guessable-rules");

        // Function to determine if the gender is "guessable" based on the noun's ending
        function isGuessable(frenchWord, prefix) {
            const lowerCaseWord = frenchWord.toLowerCase(); // Avoid case sensitivity
            if (lowerCaseWord.endsWith('e')) {
                if (lowerCaseWord.endsWith('age') || lowerCaseWord.endsWith('ege') || lowerCaseWord.endsWith('é') || lowerCaseWord.endsWith('isme')) {
                    return false; // Likely masculine
                }
                return true; // Likely feminine
            } else {
                return false; // Likely masculine
            }
        }

        // Function to load list from file and validate
        function loadListFromFile(filename) {
            fetch(filename)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to load file: ${filename} (status ${response.status})`);
                    }
                    return response.text();
                })
                .then(text => {
                    if (!text) {
                        errorMessage.text(`File ${filename} is empty.`);
                        console.warn(`File ${filename} is empty.`);
                        return;
                    }

                    let validLines = [];
                    const lines = text.split('\n');

                    lines.forEach(line => {
                        line = line.trim();
                        if (!line) return; // Skip empty lines

                        const parts = line.split(' ');
                        if (parts.length < 3) {
                            console.warn("Invalid line format: ", line);
                            errorMessage.text("Invalid line format in file. Please use 'english prefix french'. See console for more.");
                            return;
                        }

                        const englishWord = parts[0].trim();
                        const prefix = parts[1].trim().toLowerCase();
                        const frenchWord = parts.slice(2).join(' ').trim();  // Handle multi-word French nouns

                        const validPrefixes = ["le", "la", "un", "une"];
                        if (!validPrefixes.includes(prefix)) {
                            console.warn("Invalid prefix: ", prefix, " in line: ", line);
                            errorMessage.text("Invalid gender prefix in file.  Valid prefixes are: le, la, un, une. See console for more.");
                            return;
                        }
                        validLines.push(line);
                    });

                    wordListTextarea.val(validLines.join('\n')); // Replace existing content
                    localStorage.setItem(localStorageKey, wordListTextarea.val()); //Update local storage

                })
                .catch(error => {
                    errorMessage.text(`Error loading list from ${filename}. See console for details.`);
                    console.error("Error loading list:", error);
                });
        }


        // Populate the list selector
        availableLists.forEach(filename => {
            listSelector.append($("<option>").val(filename).text(filename));
        });

        // Load list on button click
        loadListButton.click(function () {
            const selectedFile = listSelector.val();
            loadListFromFile(selectedFile);
        });


        // Load word list from local storage on page load
        if (localStorage.getItem(localStorageKey)) {
            wordListTextarea.val(localStorage.getItem(localStorageKey));
        }

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
        }

        function generateSlideshow(wordList) {
            slideshowContainer.empty(); // Clear any existing slides
            slides = []; // Reset the slides array
            currentSlideIndex = 0;
            errorMessage.text("");  // Clear any previous errors

            let lines = wordList.split('\n');
            shuffleArray(lines); // Shuffle the array of lines

            let validWordsCount = 0;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return; // Skip empty lines

                const parts = line.split(' ');
                if (parts.length < 3) {
                    console.warn("Invalid line format: ", line);
                    errorMessage.text("Invalid line format. Please use 'english prefix french'. See console for more.");
                    return;
                }

                const englishWord = parts[0].trim();
                const prefix = parts[1].trim().toLowerCase();
                const frenchWord = parts.slice(2).join(' ').trim();  // Handle multi-word French nouns

                const validPrefixes = ["le", "la", "un", "une"];
                if (!validPrefixes.includes(prefix)) {
                    console.warn("Invalid prefix: ", prefix, " in line: ", line);
                    errorMessage.text("Invalid gender prefix.  Valid prefixes are: le, la, un, une. See console for more.");
                    return;
                }

                let genderClass = 'neutral';
                if (["le", "un"].includes(prefix)) {
                    genderClass = 'masculine';
                } else if (["la", "une"].includes(prefix)) {
                    genderClass = 'feminine';
                }

                let definiteArticle = (prefix === "un" || prefix === "une") ? "" : prefix; //initailise as before

                const startsWithVowelOrH = /^[aeiouh]/i.test(frenchWord); //use regex

                if (startsWithVowelOrH && (prefix === "le" || prefix === "la")) {
                    definiteArticle = "l'";  // Contract the article
                } else {
                    definiteArticle = prefix;
                }

                const possessiveArticle = (genderClass === 'masculine') ? "son" : "ta";
                const wordWithDefiniteArticle =  definiteArticle + " " + frenchWord;
                const wordWithOne =  (genderClass === 'masculine') ? "un " + frenchWord : "une " + frenchWord;

                const guessable = isGuessable(frenchWord, prefix);
                let guessableText = guessable ? "✅ Guessable" : "❌ Not Guessable";

                const slideContent = `
                    <p class="english-word"><b>${englishWord}</b></p>
                    <p>${wordWithOne}</p>
                    <p>${wordWithDefiniteArticle}</p>
                    <p>${possessiveArticle} ${frenchWord}</p>
                    <p>${guessableText}</p>
                `;

                const slide = $(`<div class="slide ${genderClass}">${slideContent}</div>`);
                slideshowContainer.append(slide);
                slides.push(slide);
                validWordsCount++;
            });

            if (validWordsCount === 0) {
                errorMessage.text("No valid words found in the input.");
                return;
            }

            showSlide(0); // Show the first slide
            inputArea.hide();
            generateButton.hide();
            slideshowContainer.show();
            navigationButtons.show();
            guessableRulesDiv.show(); // Show the rules div

            // Save word list to local storage
            localStorage.setItem(localStorageKey, wordList);
        }

        function showSlide(index) {
            if (index < 0) {
                currentSlideIndex = slides.length - 1;
            } else if (index >= slides.length) {
                currentSlideIndex = 0;
            } else {
                currentSlideIndex = index;
            }

            $(".slide").removeClass("active");
            slides[currentSlideIndex].addClass("active");
        }

        generateButton.click(function () {
            const wordList = wordListTextarea.val();
            generateSlideshow(wordList);
        });

        prevButton.click(function () {
            showSlide(currentSlideIndex - 1);
        });

        nextButton.click(function () {
            showSlide(currentSlideIndex + 1);
        });

         shuffleButton.click(function () {
            const wordList = wordListTextarea.val();
            generateSlideshow(wordList);
        });

        editButton.click(function () {
            slideshowContainer.hide();
            navigationButtons.hide();
            guessableRulesDiv.hide(); // Hide the rules div
            inputArea.show();
            generateButton.show();
        });

        // Save word list to local storage when the textarea changes - this is an alternative approach that might be better
        wordListTextarea.on('input', function() {
            localStorage.setItem(localStorageKey, wordListTextarea.val());
        });
    });
</script>

</body>
</html>